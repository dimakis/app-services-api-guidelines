extends: spectral:oas
functions:
  - expectServersConfig
  - objectReferenceSchema
  - securitySchemes
  - infoLicenseApache2
  - schemaDefinition
  - externalRefs
rules:
  openapi-tags: off
  operation-tags: off
  # openapi spec rules, that return errors
  oas3-valid-schema-example: off
  no-$ref-siblings: off
  # openapi spec rules, that return warnings
  operation-description: off
  operation-tag-defined: off
  info-contact: off
  oas3-unused-components-schema: off
  # RHOAS specific rules deleted:
  # - rhoas-info-license-apache2.0
  # - rhoas-response-media-type
  # - rhoas-error-schema
  # - rhoas-schema-name-camel-case



  rhoas-external-$ref:
    given: "$..['$ref']"
    severity: error
    type: 'validation'
    resolved: false
    then:
      function: externalRefs
  rhoas-oas3minimum:
    given: "$"
    description: OpenAPI version must be >= 3
    recommended: true
    severity: warn
    then:
      field: openapi
      function: pattern
      functionOptions:
        match: 3.[0-9]?.[0-9]
  rhoas-servers-config:
    given: "$"
    severity: warn
    recommended: true
    then:
      function: expectServersConfig
      field: servers
      functionOptions:
        required:
          - https://api.openshift.com
          - https://api.stage.openshift.com
          - http://localhost:8000
          - "/"
  rhoas-path-regexp:
    given: "$.paths[*]~"
    severity: warn
    description:
      OpenAPI paths must start with `/api/`, followed by a version. All paths
      must follow camel_case
    then:
      function: pattern
      functionOptions:
        match: "\/api\/([a-z_]*){1,}(\/v[0-9]*(alpha|beta)?)(\/{?[a-z_]*}?){0,}$"
  rhoas-object-resource-schema:
    given: "$.paths..responses[?( @property < 300)].content.*"
    severity: error
    then:
      function: schema
      field: schema
      functionOptions:
        schema:
          "$ref": "#/components/schemas/ObjectReference"
  rhoas-schema-properties-snake-case:
    description:
      All JSON Schema properties MUST follow snake_case and be ASCII alphanumeric
      characters.
    severity: error
    recommended: true
    message: "`{{property}}` MUST follow snake_case and be ASCII alphanumeric characters."
    given: "$.components.schemas..properties[*]~"
    then:
      function: pattern
      functionOptions:
        match: "/^[a-z0-9_]{1,}/"
  rhoas-object-schema:
    severity: error
    recommended: true
    given: "$.components.schemas"
    then:
      function: schemaDefinition
      field: ObjectReference
      functionOptions:
        definition:
          type: object
          properties:
            id:
              type: string
              required: true
            kind:
              type: string
              required: true
            href:
              type: string
              required: true
  rhoas-list-schema:
    severity: error
    recommended: true
    given: "$.components.schemas"
    then:
      function: schemaDefinition
      field: List
      functionOptions:
        definition:
          type: object
          properties:
            items:
              type: array
              required: true
            kind:
              type: string
              required: true
            page:
              type: integer
              required: true
            size:
              type: integer
              required: true
            total:
              type: integer
              required: true
